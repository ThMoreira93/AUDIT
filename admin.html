<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AUDIT – Auditoria de Viagens</title>
<link rel="icon" type="image/png" href="favicon.png">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>
  
  <style>
    :root {
      --primary: #6D28D9;
      --primary-hover: #5B21B6;
      --primary-light: #EDE9FE;
      --bg-main: #F8FAFC;
      --bg-card: #FFFFFF;
      --text-main: #1E293B;
      --text-muted: #64748B;
      --border: #E2E8F0;
      --success: #10B981;
      --danger: #EF4444;
      --warning: #F59E0B;
      --overlay: rgba(15, 23, 42, 0.95);
    }

    * { box-sizing: border-box; -webkit-font-smoothing: antialiased; }
    body { margin: 0; background: var(--bg-main); font-family: 'Inter', sans-serif; color: var(--text-main); min-height: 100vh; }

    /* ===== IMPRESSÃO ===== */
    @media print {
      @page { size: landscape; margin: 5mm; }
      body > *:not(#printArea) { display: none !important; }
      #printArea { display: block !important; position: absolute; left: 0; top: 0; width: 100%; background: white; padding: 0; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { border: 1px solid #000; padding: 4px 6px; font-size: 8pt; text-align: left; }
      th { background: #eee !important; -webkit-print-color-adjust: exact; }
    }
    #printArea { display: none; padding: 20px; }

    /* ===== NAVEGAÇÃO SUPERIOR ===== */
    header.top-bar {
      background: #1E1B4B; color: white; height: 70px; padding: 0 30px;
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 800; font-size: 20px; }
    .brand .logo { width: 38px; height: 38px; background: var(--primary); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    
    nav.nav-links { display: flex; height: 100%; margin-left: 20px; }
    nav.nav-links a {
      display: flex; align-items: center; padding: 0 18px; color: #94A3B8; text-decoration: none;
      font-weight: 600; font-size: 14px; border-bottom: 3px solid transparent; transition: 0.2s;
    }
    nav.nav-links a:hover { color: white; background: rgba(255,255,255,0.05); }
    nav.nav-links a.active { color: white; border-bottom-color: var(--primary); background: rgba(109, 40, 217, 0.1); }

    .user-actions { display: flex; align-items: center; gap: 15px; }
    .btn-logout { background: #EF4444; color: white; border: none; padding: 8px 12px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; }

    /* ===== CONTENT ===== */
    .app-content { max-width: 1600px; margin: 30px auto; padding: 0 20px; }
    .card { background: #fff; border-radius: 20px; padding: 25px; border: 1px solid var(--border); margin-bottom: 25px; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
    .card h3 { margin: 0 0 20px; font-size: 17px; font-weight: 800; display: flex; align-items: center; gap: 10px; }

    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
    .kpi-card { padding: 22px; border-radius: 18px; background: white; border: 1px solid var(--border); display: flex; flex-direction: column; gap: 5px; }
    .kpi-label { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; }
    .kpi-value { font-size: 26px; font-weight: 900; }

    .table-responsive { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    th { text-align: left; padding: 14px 10px; background: #F8FAFC; font-size: 10px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; border-bottom: 2px solid var(--border); }
    td { padding: 12px 10px; border-bottom: 1px solid var(--border); font-size: 12px; vertical-align: top; }

    .pill { padding: 4px 8px; border-radius: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .pill.ok { background: #DCFCE7; color: #166534; }
    .pill.bad { background: #FEE2E2; color: #991B1B; }
    .pill.wait { background: #FEF3C7; color: #92400E; }

    .input, select { padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-size: 13px; outline: none; transition: 0.2s; background: white; width: 100%; }
    .btn { padding: 10px 20px; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-danger { background: var(--danger); color: white; }
    .btn-light { background: white; border: 1.5px solid var(--border); color: var(--text-main); }

    /* ===== MODAL SPREADSHEET ===== */
    .modal-overlay { position: fixed; inset: 0; background: var(--overlay); display: none; align-items: center; justify-content: center; z-index: 2000; backdrop-filter: blur(8px); }
    .modal-content { background: white; width: 95%; max-width: 1100px; padding: 35px; border-radius: 24px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
    
    .spreadsheet-wrap { flex: 1; overflow: auto; border: 1px solid var(--border); border-radius: 12px; background: #f1f5f9; margin: 20px 0; }
    .sheet-table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; table-layout: fixed; }
    .sheet-table th { position: sticky; top: 0; background: #e2e8f0; z-index: 10; border: 1px solid #cbd5e1; font-size: 11px; padding: 8px; text-align: center; }
    .sheet-table td { border: 1px solid #e2e8f0; padding: 0; overflow: hidden; }
    .sheet-table .cell { min-height: 35px; padding: 8px; outline: none; font-size: 13px; white-space: nowrap; }
    .sheet-table .cell:focus { background: var(--primary-light); box-shadow: inset 0 0 0 2px var(--primary); }
    .sheet-table .row-num { width: 40px; background: #f8fafc; text-align: center; font-weight: bold; color: #94a3b8; font-size: 11px; border: 1px solid #cbd5e1; }

    /* LOGIN */
    .login-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; background: #1E1B4B; }
    .login-card { background: white; padding: 45px; border-radius: 30px; width: 100%; max-width: 400px; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
  
  .toast{position:fixed; left:50%; top:18px; transform:translateX(-50%) translateY(-14px); 
    background:#10B981; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; 
    box-shadow:0 10px 24px rgba(0,0,0,.2); font-weight:800; z-index:3000; transition:.25s}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  .toast.error{background:#EF4444}
</style>
</head>
<body>

  <!-- AREA DE IMPRESSÃO (CORRIGIDA) -->
  <div id="printArea">
    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:2px solid #000; padding-bottom:10px; margin-bottom:15px">
      <div style="font-weight:800; font-size:20px; color:#6D28D9"><i class="fa-solid fa-route"></i> AUDIT    </div>
      <div id="pDate" style="font-size:10px"></div>
    </div>
    <h2 id="pTitle" style="margin:0; font-size:16px">Relatório de Lançamentos Viagens</h2>
    <p id="pSub" style="margin:5px 0 15px 0; font-weight:bold; font-size:12px"></p>
    <div id="pContainer"></div>
    <div style="text-align:right; margin-top:20px; border-top:2px solid #000; padding-top:10px">
      <h3 style="font-size:14px">Soma Total Aprovada: <span id="pTotalValue">R$ 0,00</span></h3>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="recoverScreen" class="login-screen" style="display:none">
  <div class="login-card">
    <div style="text-align:center; margin-bottom:20px">
      <h2 style="margin:0; font-weight:800">Recuperar senha</h2>
      <p style="color:#64748B; font-size:13px">Informe seu e-mail corporativo para receber o link.</p>
    </div>
    <div style="display:grid; gap:18px">
      <input id="recEmail" class="input" placeholder="E-mail corporativo"/>
      <div style="display:flex; gap:10px; justify-content:space-between">
        <button id="btnBackLogin" class="btn btn-light" style="flex:1"><i class="fa-solid fa-arrow-left"></i> Voltar</button>
        <button id="btnSendReset" type="button" class="btn btn-primary" style="flex:1; background:#7C3AED"><i class="fa-solid fa-paper-plane"></i> Enviar link</button>
      </div>
    </div>
  </div>
</div>

<div id="loginScreen" class="login-screen">
    <div class="login-card">
      <div style="text-align:center; margin-bottom:30px">
        <div style="width:60px; height:60px; background:var(--primary); color:white; border-radius:15px; display:flex; align-items:center; justify-content:center; font-size:28px; margin:0 auto 7px"><i class="fa-solid fa-route"></i></div>
        <h2 style="margin:0; font-weight:800">AUDIT</h2>
        <p style="color:var(--text-muted); font-size:13px; margin-top:1px">Auditoria de Viagens</p>
      </div>
      <div style="display:grid; gap:18px">
        <input id="email" class="input" placeholder="E-mail corporativo"/>
        <input id="senha" type="password" class="input" placeholder="Sua senha"/>
        <div style="text-align:left; margin-top:-8px"><a id="recSenha" style="color:#6D28D9; font-weight:700; font-size:13px; cursor:pointer">Recuperar senha</a></div>
      <button id="btnLogin" class="btn btn-primary" style="justify-content:center; padding:14px 22px; border-radius:16px; background:#7C3AED; font-size:15px">Entrar no Sistema</button>
        <div id="loginMsg" style="text-align:center; color:var(--danger); font-size:13px"></div>
      </div>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="appShell" style="display:none">
    <header class="top-bar">
      <div class="brand"><div class="logo"><i class="fa-solid fa-route"></i></div> <span>AUDIT</span></div>
      <nav class="nav-links" id="nav">
        <a href="#dash" data-tab="dash" class="active"><i class="fa-solid fa-chart-pie"></i> Dashboard</a>
        <a href="#lanca" data-tab="lanca"><i class="fa-solid fa-table-list"></i> Lançamentos</a>
        <a href="#mass" data-tab="mass"><i class="fa-solid fa-bolt"></i> Massa</a>
        <a href="#veic" data-tab="veic"><i class="fa-solid fa-car"></i> Veículos</a>
        <a href="#admin" data-tab="admin" id="tabAdminLink" style="display:none"><i class="fa-solid fa-user-gear"></i> Admin</a>
      </nav>
      <div class="user-actions">
        <div style="text-align:right; font-size:12px">
          <div id="userBox" style="font-weight:700">Laura Bispo Moreira</div>
          <div id="userRole" style="color:#94A3B8; font-weight:700; text-transform:uppercase">Acesso</div>
        </div>
        <button id="btnLogout" class="btn-logout"><i class="fa-solid fa-power-off"></i></button>
      </div>
    </header>

    <main class="app-content">
      <!-- DASHBOARD -->
      <section id="tab-dash">
        <div class="card">
          <h3><i class="fa-solid fa-filter"></i> Filtros Dashboard (BI)</h3>
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end">
            <div><label style="font-size:11px; font-weight:700">INÍCIO</label><input type="date" class="input" id="dFiltroIni"></div>
            <div><label style="font-size:11px; font-weight:700">FIM</label><input type="date" class="input" id="dFiltroFim"></div>
            <div><label style="font-size:11px; font-weight:700">STATUS</label><select id="dFiltroStatus" class="input"><option value="">Todos</option><option>Pendente</option><option>Aprovado</option><option>Reprovado</option></select></div>
            <div style="display:flex; gap:10px">
              <button class="btn btn-primary" id="btnAplicaDash" style="flex:1">Atualizar Gráficos</button>
              <button class="btn btn-light" id="btnLimpaDash"><i class="fa-solid fa-rotate"></i></button>
            </div>
          </div>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card"><span class="kpi-label">Lançamentos</span><span class="kpi-value" id="kTotal">0</span></div>
          <div class="kpi-card" style="border-left: 4px solid var(--success)"><span class="kpi-label">Aprovados</span><span class="kpi-value" id="kAprov" style="color:var(--success)">0</span></div>
          <div class="kpi-card" style="border-left: 4px solid var(--warning)"><span class="kpi-label">Pendentes</span><span class="kpi-value" id="kPend" style="color:var(--warning)">0</span></div>
          <div class="kpi-card" style="border-left: 4px solid var(--primary)"><span class="kpi-label">Total Aprovado</span><span class="kpi-value" id="kVal">R$ 0,00</span></div>
        </div>

        <div class="card"><h3>Distribuição por Status</h3><div style="height:200px"><canvas id="chStatus"></canvas></div></div>
        <div class="card"><h3>Top 10 Colaboradores (R$)</h3><div style="height:100px"><canvas id="chTop"></canvas></div></div>
        <div class="card"><h3>Ranking Completo Aprovados</h3><div id="tblRankContainer" class="table-responsive"></div></div>
      </section>

      <!-- LANÇAMENTOS -->
      <section id="tab-lanca" style="display:none">
        <div class="card">
          <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:15px; align-items:end">
            <div><label>DATA INICIAL</label><input type="date" class="input" id="lFiltroIni"></div>
            <div><label>DATA FINAL</label><input type="date" class="input" id="lFiltroFim"></div>
            <div><label>COLABORADOR</label><select id="lFiltroColab" class="input"><option value="">Todos</option></select></div>
            <div style="display:flex; gap:10px">
              <button class="btn btn-primary" id="btnAplicaLanca" style="flex:1">Filtrar Lançamentos</button>
              <button class="btn btn-light" id="btnLimpaLanca"><i class="fa-solid fa-eraser"></i></button>
              <button class="btn btn-light" id="btnImprimir"><i class="fa-solid fa-print"></i></button>
              <button class="btn btn-light" id="btnExport"><i class="fa-solid fa-file-excel"></i></button>
            </div>
          </div>
        </div>
        <div class="card"><div id="tblLancaContainer" class="table-responsive"></div></div>
      </section>

      <!-- MASSA / VEICULOS -->
      <section id="tab-mass" style="display:none">
        <div class="card" style="text-align:center; padding:80px">
          <i class="fa-solid fa-bolt fa-4x" style="color:var(--primary); margin-bottom:20px"></i>
          <h2>Ação em Massa</h2>
          <button class="btn btn-primary" onclick="openSpreadsheet('mass')">Abrir Planilha de Status</button>
        </div>
      </section>

      <section id="tab-veic" style="display:none">
        <div style="display:grid; grid-template-columns: 1fr 2.5fr; gap:25px">
          <div class="card" style="text-align:center">
            <i class="fa-solid fa-car fa-3x" style="color:var(--primary); margin-bottom:15px"></i>
            <h3>Gestão de Frota</h3>
            <button class="btn btn-primary" style="width:100%" onclick="openSpreadsheet('veic')">Abrir Planilha de Veículos</button>
          </div>
          <div class="card"><div id="tblVeicContainer" class="table-responsive"></div></div>
        </div>
      </section>
    </main>
  </div>

  <!-- MODAL PLANILHA FLUTUANTE -->
  <div id="modalSheet" class="modal-overlay">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center">
        <div><h2 id="sheetTitle" style="margin:0">Planilha de Importação</h2><p style="font-size:12px; color:var(--text-muted); margin-top:5px">Pressione <b>Ctrl+V</b> na primeira célula branca para colar do Excel.</p></div>
        <button class="btn-light" onclick="closeSpreadsheet()"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="spreadsheet-wrap">
        <table class="sheet-table" id="mainSheet">
          <thead id="sheetHead"></thead>
          <tbody id="sheetBody"></tbody>
        </table>
      </div>
      <div style="display:flex; justify-content:space-between; align-items:center">
        <button class="btn btn-light" onclick="addRows(50)">+ 50 Linhas</button>
        <div style="display:flex; gap:10px">
          <button class="btn btn-light" onclick="closeSpreadsheet()">Cancelar</button>
          <button class="btn btn-primary" id="btnSaveSheet">Salvar Dados</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL EDIÇÃO -->
  <div id="modalEdit" class="modal-overlay">
    <div class="modal-content" style="max-width:600px">
      <h2 id="editTitle">Editar Registro</h2>
      <div id="editBody" style="display:grid; gap:15px; margin-top:15px"></div>
      <div style="margin-top:25px; display:flex; gap:10px; justify-content:flex-end">
        <button class="btn btn-light" onclick="closeEdit()">Fechar</button>
        <button class="btn btn-primary" id="btnSaveEdit">Gravar</button>
      </div>
    </div>
  </div>

  <!-- MODAL CONFIRMAÇÃO EXCLUSÃO -->
  <div id="modalConfirm" class="modal-overlay">
    <div class="modal-content" style="max-width:400px; text-align:center">
      <div style="color:var(--danger); font-size:40px; margin-bottom:15px"><i class="fa-solid fa-triangle-exclamation"></i></div>
      <h3 id="confirmTitle">Confirmar?</h3>
      <p id="confirmMsg"></p>
      <div style="margin-top:25px; display:flex; gap:10px; justify-content:center">
        <button class="btn btn-light" onclick="closeConfirm()">Cancelar</button>
        <button class="btn btn-danger" id="btnDeleteConfirm">Sim, Excluir</button>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js">
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>

  <script>
    const firebaseConfig = {"apiKey":"AIzaSyBMtXm9wInJb9xrBFU5gyEIMKuWuVzknSU","authDomain":"deslocamento-3bcd0.firebaseapp.com","projectId":"deslocamento-3bcd0","storageBucket":"deslocamento-3bcd0.firebasestorage.app","messagingSenderId":"1041622437635","appId":"1:1041622437635:web:9a0e8b026879919676e336","measurementId":"G-JKWV37MFHB"};
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const $ = (id) => document.getElementById(id);

    Chart.register(ChartDataLabels);

    let cacheSolic = [], cacheVeic = [], userProfile = null, unsubSolic = null, unsubVeic = null;
    let filterD = { ini: null, fim: null, status: '' };
    let filterL = { ini: null, fim: null, colab: '' };
    let activeSheetType = 'mass', delType = 'solic', delId = null;

    // --- AUTH ---
    auth.onAuthStateChanged(async (user) => {
      if(user) {
        $('loginScreen').style.display = 'none';
        $('appShell').style.display = 'block';
        const doc = await db.collection('usuarios').doc(user.uid).get();
        userProfile = doc.exists ? doc.data() : { nome: user.email, funcao: 'gestor' };
        $('userBox').textContent = userProfile.nome;
        $('userRole').textContent = userProfile.funcao;
        if(userProfile.funcao === 'admin') $('tabAdminLink').style.display = 'flex';
        initApp();
      } else {
        $('loginScreen').style.display = 'flex';
        $('appShell').style.display = 'none';
      }
    });

    $('btnLogin').onclick = async () => {
      const e = $('email').value, s = $('senha').value;
      if(!e || !s) return;
      try { await auth.signInWithEmailAndPassword(e, s); } catch(err) { $('loginMsg').textContent = "Acesso negado."; }
    };
    $('btnLogout').onclick = () => auth.signOut();

    function initApp() {
      const navLinks = document.querySelectorAll('#nav a');
      navLinks.forEach(t => {
        t.onclick = (e) => {
          e.preventDefault();
          document.querySelectorAll('#nav a').forEach(x => x.classList.remove('active'));
          t.classList.add('active');
          document.querySelectorAll('main section').forEach(s => s.style.display = 'none');
          $('tab-' + t.dataset.tab).style.display = 'block';
        }
      });
      if(unsubSolic) unsubSolic();
      unsubSolic = db.collection('solicitacoes_diaria').orderBy('createdAt', 'desc').onSnapshot(snap => {
        cacheSolic = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
        populateFilters(); renderDash(); renderLanca();
      });
      if(unsubVeic) unsubVeic();
      unsubVeic = db.collection('veiculos').onSnapshot(snap => {
        cacheVeic = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
        renderVeiculos();
      });
    }

    function brl(v) { return Number(v || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

    function populateFilters() {
      const nomes = [...new Set(cacheSolic.map(d => d.colaborador).filter(Boolean))].sort();
      const sel = $('lFiltroColab');
      const cur = sel.value;
      sel.innerHTML = '<option value="">Todos os Colaboradores</option>';
      nomes.forEach(n => { sel.innerHTML += `<option value="${n}">${n}</option>`; });
      sel.value = cur;
    }

    // --- MOTOR DE FILTRAGEM (REESCRITO E CORRIGIDO) ---
    function runFilter(data, f) {
      return data.filter(x => {
        // Filtro de Status (se existir no filtro)
        if(f.status && x.status !== f.status) return false;
        
        // Filtro de Colaborador (se existir no filtro)
        if(f.colab && x.colaborador !== f.colab) return false;
        
        // Filtro de Datas (Conversão absoluta para Timestamps locais)
        if(f.ini || f.fim) {
          // Data do registro: usa createdAt ou reconstrói da dataSaida
          let recordDate = x.createdAt ? new Date(x.createdAt) : new Date(x.dataSaida + "T12:00:00");
          recordDate.setHours(0,0,0,0);
          const recordTime = recordDate.getTime();

          if(f.ini) {
            const startTime = new Date(f.ini + "T00:00:00").getTime();
            if(recordTime < startTime) return false;
          }
          if(f.fim) {
            const endTime = new Date(f.fim + "T00:00:00").getTime();
            if(recordTime > endTime) return false;
          }
        }
        return true;
      });
    }

    // --- DASHBOARD LOGIC ---
    $('btnAplicaDash').onclick = () => {
      filterD.ini = $('dFiltroIni').value;
      filterD.fim = $('dFiltroFim').value;
      filterD.status = $('dFiltroStatus').value;
      renderDash();
    };
    $('btnLimpaDash').onclick = () => {
      ['dFiltroIni','dFiltroFim','dFiltroStatus'].forEach(id => $(id).value = '');
      filterD = { ini: null, fim: null, status: '' };
      renderDash();
    };

    function renderDash() {
      const d = runFilter(cacheSolic, filterD);
      const aprov = d.filter(x => x.status === 'Aprovado');
      $('kTotal').textContent = d.length;
      $('kAprov').textContent = aprov.length;
      $('kPend').textContent = d.filter(x => x.status === 'Pendente').length;
      $('kVal').textContent = brl(aprov.reduce((s, x) => s + (x.valor || 0), 0));

      const sMap = { Pendente:0, Aprovado:0, Reprovado:0 };
      d.forEach(x => sMap[x.status]++);
      const cMap = {};
      aprov.forEach(x => { cMap[x.colaborador] = (cMap[x.colaborador]||0) + (x.valor||0); });
      const sorted = Object.entries(cMap).map(([k,v])=>({k,v})).sort((a,b)=>b.v-a.v);
      const rRows = sorted.map((r, i) => `<tr><td style="width:50px; font-weight:800">${i+1}º</td><td><b>${r.k}</b></td><td style="text-align:right">${brl(r.v)}</td></tr>`).join('');
      $('tblRankContainer').innerHTML = `<table><thead><tr><th>POS</th><th>COLABORADOR</th><th style="text-align:right">APROVADO</th></tr></thead><tbody>${rRows || '<tr><td colspan="3">Vazio</td></tr>'}</tbody></table>`;

      try {
        if(window._c1) window._c1.destroy();
        if(window._c2) window._c2.destroy();
        window._c1 = new Chart($('chStatus'), { type:'doughnut', data: { labels: Object.keys(sMap), datasets:[{ data: Object.values(sMap), backgroundColor:['#F59E0B','#10B981','#EF4444'], borderWidth: 0 }] }, options: { maintainAspectRatio:false, cutout:'70%', plugins: { legend: { position: 'right' }, datalabels: { color: '#fff', font: { weight: 'bold' } } } } });
        const top10 = sorted.slice(0, 10);
        window._c2 = new Chart($('chTop'), { type:'bar', data: { labels: top10.map(x => x.k), datasets: [{ label:'R$', data: top10.map(x => x.v), backgroundColor:'#6D28D9', borderRadius: 6 }] }, options: { indexAxis: 'y', maintainAspectRatio:false, plugins: { legend: { display: false }, datalabels: { anchor:'end', align:'end', color:'#1E293B', font:{size:10, weight:'bold'}, formatter: (v) => v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL', maximumFractionDigits:0 }) } }, scales: { x: { display: false }, y: { grid: { display: false } } } } });
      } catch(e){}
    }

    // --- LANÇAMENTOS LOGIC ---
    $('btnAplicaLanca').onclick = () => {
      filterL.ini = $('lFiltroIni').value;
      filterL.fim = $('lFiltroFim').value;
      filterL.colab = $('lFiltroColab').value;
      renderLanca();
    };
    $('btnLimpaLanca').onclick = () => {
      ['lFiltroIni','lFiltroFim','lFiltroColab'].forEach(id => $(id).value = '');
      filterL = { ini: null, fim: null, colab: '' };
      renderLanca();
    };

    function renderLanca() {
      const d = runFilter(cacheSolic, filterL);
      const rows = d.map(x => `
        <tr>
          <td style="font-weight:700">#${x.numero}</td>
          <td><b>${x.colaborador || '-'}</b></td>
          <td>${x.destino || '-'}</td>
          <td style="font-size:11px">${x.placa || '-'}<br><small>${x.frota || '-'}</small></td>
          <td style="white-space:nowrap">${(x.dataSaida||'').split('-').reverse().join('/')}<br><small>${x.horaSaida||''}</small></td>
          <td style="white-space:nowrap">${x.dataRetorno ? x.dataRetorno.split('-').reverse().join('/') : '-'}<br><small>${x.horaRetorno || '-'}</small></td>
          <td style="font-weight:700">${x.duracaoTexto || '-'}</td>
          <td style="font-weight:800">${brl(x.valor)}</td>
          <td><span class="pill ${x.status==='Aprovado'?'ok':(x.status==='Reprovado'?'bad':'wait')}">${x.status}</span></td>
          <td style="font-size:10px; color:var(--text-muted); max-width:180px">${x.observacao || ''}</td>
          <td>
            <div style="display:flex; gap:5px">
              <select class="input chgStatus" data-id="${x._id}" style="padding:4px; font-size:10px; width:90px">
                <option ${x.status==='Pendente'?'selected':''}>Pendente</option>
                <option ${x.status==='Aprovado'?'selected':''}>Aprovado</option>
                <option ${x.status==='Reprovado'?'selected':''}>Reprovado</option>
              </select>
              <button class="btn btn-primary" style="padding:6px 10px" onclick="openEditLanca('${x._id}')"><i class="fa-solid fa-pen"></i></button>
              <button class="btn btn-danger" style="padding:6px 10px" onclick="askDelete('solic', '${x._id}')"><i class="fa-solid fa-trash"></i></button>
            </div>
          </td>
        </tr>
      `).join('');
      $('tblLancaContainer').innerHTML = `<table><thead><tr><th>Nº</th><th>Colab</th><th>Destino</th><th>Veículo</th><th>Saída</th><th>Chegada</th><th>Duração</th><th>Valor</th><th>Status</th><th>Obs</th><th>Ação</th></tr></thead><tbody>${rows || '<tr><td colspan="11">Vazio.</td></tr>'}</tbody></table>`;
      document.querySelectorAll('.chgStatus').forEach(s => { s.onchange = async () => { if(s.value==='Reprovado') openEditLanca(s.dataset.id, true); else await db.collection('solicitacoes_diaria').doc(s.dataset.id).update({status:s.value}); }; });
    }

    // --- IMPRESSÃO ---
    $('btnImprimir').onclick = () => {
      const d = runFilter(cacheSolic, filterL);
      if(!d.length) return alert('Não há dados filtrados para imprimir.');
      $('pDate').textContent = "Gerado em: " + new Date().toLocaleString();
      $('pSub').textContent = `Período: ${$('lFiltroIni').value || 'Início'} a ${$('lFiltroFim').value || 'Fim'} | Colab: ${filterL.colab || "Todos"}`;
      let total = 0;
      const htmlTable = d.map(x => {
        if(x.status === 'Aprovado') total += (x.valor || 0);
        return `<tr>
          <td>${x.numero}</td><td>${x.colaborador}</td><td>${x.destino}</td><td>${x.placa||'-'} / ${x.frota||'-'}</td>
          <td>${(x.dataSaida||'').split('-').reverse().join('/')} ${x.horaSaida||''}</td><td>${x.dataRetorno?x.dataRetorno.split('-').reverse().join('/'):'-'} ${x.horaRetorno||''}</td>
          <td>${x.duracaoTexto||'-'}</td><td>${brl(x.valor)}</td><td>${x.status}</td><td>${x.observacao||''}</td>
        </tr>`;
      }).join('');
      $('pContainer').innerHTML = `<table><thead><tr><th>Nº</th><th>Colab</th><th>Destino</th><th>Veículo</th><th>Saída</th><th>Chegada</th><th>Duração</th><th>Valor</th><th>Status</th><th>Obs</th></tr></thead><tbody>${htmlTable}</tbody></table>`;
      $('pTotalValue').textContent = brl(total);
      setTimeout(() => { window.print(); }, 500);
    };

    // --- GESTÃO DE VEÍCULOS ---
    function renderVeiculos() {
      const rows = cacheVeic.map(v => `<tr><td><b>${v._id}</b></td><td>${v.frota || '-'}</td><td><div style="display:flex;gap:5px"><button class="btn btn-primary" onclick="openEditVeic('${v._id}')" style="padding:6px"><i class="fa-solid fa-pen"></i></button><button class="btn btn-danger" onclick="askDelete('veic','${v._id}')" style="padding:6px"><i class="fa-solid fa-trash"></i></button></div></td></tr>`).join('');
      $('tblVeicContainer').innerHTML = `<table><thead><tr><th>Placa</th><th>Frota</th><th>Ação</th></tr></thead><tbody>${rows || '<tr><td colspan="3">Vazio</td></tr>'}</tbody></table>`;
    }

    // --- SPREADSHEET ENGINE ---
    function openSpreadsheet(t) { activeSheetType = t; $('modalSheet').style.display = 'flex'; $('sheetTitle').textContent = t === 'mass' ? 'Atualizar Status' : 'Cadastrar Frota'; $('sheetHead').innerHTML = t === 'mass' ? `<tr><th style="width:40px">#</th><th>Nº Solicitação</th><th>Novo Status</th></tr>` : `<tr><th style="width:40px">#</th><th>Placa</th><th>Frota</th></tr>`; $('sheetBody').innerHTML = ''; addRows(100); }
    function closeSpreadsheet() { $('modalSheet').style.display = 'none'; }
    function addRows(n) {
      const b = $('sheetBody'); const start = b.children.length;
      for(let i=0; i<n; i++) {
        const tr = document.createElement('tr'); tr.innerHTML = `<td class="row-num">${start+i+1}</td><td><div class="cell" contenteditable="true"></div></td><td><div class="cell" contenteditable="true"></div></td>`;
        tr.cells[1].querySelector('div').onpaste = (e) => {
          e.preventDefault(); const text = (e.clipboardData || window.clipboardData).getData('text').trim();
          text.split(/\r?\n/).forEach((l, idx) => {
            const cols = l.split('\t'); const target = $('sheetBody').rows[start + idx];
            if(target) { target.cells[1].querySelector('div').innerText = cols[0] || ''; target.cells[2].querySelector('div').innerText = cols[1] || ''; }
          });
        };
        b.appendChild(tr);
      }
    }
    $('btnSaveSheet').onclick = async () => {
      const btn = $('btnSaveSheet'); btn.disabled = true; btn.textContent = 'Salvando...';
      const rows = Array.from($('sheetBody').rows);
      for(let r of rows) {
        const v1 = r.cells[1].querySelector('div').innerText.trim();
        const v2 = r.cells[2].querySelector('div').innerText.trim();
        if(!v1) continue;
        if(activeSheetType === 'mass') {
          const q = await db.collection('solicitacoes_diaria').where('numero', '==', String(v1)).get();
          if(!q.empty) await q.docs[0].ref.update({ status: v2 || 'Aprovado' });
        } else {
          await db.collection('veiculos').doc(v1.toUpperCase()).set({ frota: v2 || '' });
        }
      }
      closeSpreadsheet(); btn.disabled = false; btn.textContent = 'Salvar Dados';
    };

    // --- MODAIS GERAIS ---
    function openEditLanca(id, reprove = false) {
      const x = cacheSolic.find(d => d._id === id);
      $('modalEdit').style.display = 'flex'; $('editTitle').textContent = reprove ? 'Motivo da Reprovação' : 'Editar #' + x.numero;
      if(reprove) {
        $('editBody').innerHTML = `<textarea id="eObs" class="input" style="height:120px" placeholder="Justificativa..."></textarea>`;
        $('btnSaveEdit').onclick = async () => { if(!$('eObs').value) return; await db.collection('solicitacoes_diaria').doc(id).update({ status:'Reprovado', observacao:$('eObs').value }); closeEdit(); };
      } else {
        $('editBody').innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px"><div><label>DESTINO</label><input id="edD" class="input" value="${x.destino}"></div><div><label>VALOR</label><input id="edV" type="number" step="0.01" class="input" value="${x.valor}"></div></div><div><label>OBSERVAÇÃO</label><textarea id="edO" class="input" style="height:80px">${x.observacao||''}</textarea></div>`;
        $('btnSaveEdit').onclick = async () => { await db.collection('solicitacoes_diaria').doc(id).update({ destino: $('edD').value, valor: parseFloat($('edV').value), observacao: $('edO').value }); closeEdit(); };
      }
    }
    function openEditVeic(p) {
      const v = cacheVeic.find(x => x._id === p);
      $('modalEdit').style.display = 'flex'; $('editTitle').textContent = "Frota " + p;
      $('editBody').innerHTML = `<div><label>Nº DA FROTA</label><input id="edF" class="input" value="${v.frota || ''}"></div>`;
      $('btnSaveEdit').onclick = async () => { await db.collection('veiculos').doc(p).update({ frota: $('edF').value }); closeEdit(); };
    }
    function askDelete(t, id) { delType = t; delId = id; $('modalConfirm').style.display = 'flex'; $('confirmMsg').textContent = `Excluir o registro ${id}?`; }
    function closeConfirm() { $('modalConfirm').style.display = 'none'; }
    function closeEdit() { $('modalEdit').style.display = 'none'; }
    $('btnDeleteConfirm').onclick = async () => { if(delType==='veic') await db.collection('veiculos').doc(delId).delete(); else await db.collection('solicitacoes_diaria').doc(delId).delete(); closeConfirm(); };

    $('btnExport').onclick = () => {
      const d = runFilter(cacheSolic, filterL).map(x => ({ Numero: x.numero, Colaborador: x.colaborador, Valor: x.valor, Status: x.status }));
      const ws = XLSX.utils.json_to_sheet(d); const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Audit"); XLSX.writeFile(wb, `Export_${new Date().getTime()}.xlsx`);
    };

    $('btnCriarUser').onclick = async () => {
      const n=$('uNome').value, e=$('uEmail').value, f=$('uFuncao').value, s=$('uSenha').value; if(!n||!e||!s) return;
      try { const a2 = firebase.initializeApp(firebaseConfig, 'aux').auth(); await a2.createUserWithEmailAndPassword(e, s); await db.collection('usuarios').doc(a2.currentUser.uid).set({ nome:n, email:e, funcao:f }); $('userAdmMsg').textContent="Sucesso!"; await a2.signOut(); } catch(err) { $('userAdmMsg').textContent="Erro."; }
    };
  
function showToast(msg, ok=true){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
const _rec = document.getElementById('recSenha'); if(_rec){ _rec.onclick = ()=>{ document.getElementById('loginScreen').style.display='none'; document.getElementById('recoverScreen').style.display='flex'; } }
const _back = document.getElementById('btnBackLogin'); if(_back){ _back.onclick = ()=>{ document.getElementById('recoverScreen').style.display='none'; document.getElementById('loginScreen').style.display='flex'; } }
const _send = document.getElementById('btnSendReset'); if(_send){ _send.onclick = async ()=>{ const e=(document.getElementById('recEmail').value||document.getElementById('email').value||'').trim(); if(!e){ showToast('Digite seu e-mail.', false); return; } try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); } catch(err){ showToast('Erro ao enviar.', false); } } }

</script>

<div id="toast" class="toast"></div>

<script>
window.addEventListener('DOMContentLoaded', function(){
  function $(id){return document.getElementById(id)}
  function showToast(msg, ok=true){ const t=$('toast'); if(!t) return; t.textContent=msg; t.classList.remove('error'); if(!ok) t.classList.add('error'); t.classList.add('show'); setTimeout(()=>{ t.classList.remove('show'); t.classList.remove('error'); }, 3000); }
  const recLink=$('recSenha');
  const loginScreen=$('loginScreen');
  const recoverScreen=$('recoverScreen');
  const backBtn=$('btnBackLogin');
  const sendBtn=$('btnSendReset');
  if(recLink && loginScreen && recoverScreen){
    recLink.addEventListener('click', ()=>{ loginScreen.style.display='none'; recoverScreen.style.display='flex'; });
  }
  if(backBtn && loginScreen && recoverScreen){
    backBtn.addEventListener('click', ()=>{ recoverScreen.style.display='none'; loginScreen.style.display='flex'; });
  }
  if(sendBtn){
    sendBtn.addEventListener('click', async ()=>{
      const e = ( $('recEmail')?.value || $('email')?.value || '' ).trim();
      if(!e){ showToast('Digite seu e-mail.', false); return; }
      try{ await firebase.auth().sendPasswordResetEmail(e); showToast('Link enviado! Verifique sua caixa de entrada.'); }
      catch(err){ console.error(err); showToast('Erro ao enviar.', false); }
    });
  }
});
</script>

</body>
</html>

